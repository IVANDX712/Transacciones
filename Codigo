CREATE DATABASE Transacciones;
USE Transacciones;

CREATE TABLE cuentas (
  id INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50),
  saldo DECIMAL(10,2)
);

-- Insertar algunos datos de prueba en la tabla
INSERT INTO cuentas (nombre, saldo) VALUES ('Cuenta A', 1000.00);
INSERT INTO cuentas (nombre, saldo) VALUES ('Cuenta B', 500.00);

-- Crear el procedimiento almacenado
DELIMITER //
CREATE PROCEDURE transferir(IN desde INT, IN hacia INT, IN cantidad DECIMAL(10,2))
BEGIN
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    -- Error al realizar la transacción, un rollback es necesario
    ROLLBACK;
    SELECT 'Error: ', SQLERRM;
  END;

  -- Iniciar una transacción
  START TRANSACTION;

  -- Actualizar el saldo de la cuenta desde donde se transferirá
  UPDATE cuentas SET saldo = saldo - cantidad WHERE id = desde;
  -- Actualizar el saldo de la cuenta hacia donde se transferirá
  UPDATE cuentas SET saldo = saldo + cantidad WHERE id = hacia;

  -- Realizar la transferencia completa
  COMMIT;

  -- Mostrar el mensaje de éxito
  SELECT 'Transferencia completada exitosamente';

END //
DELIMITER ;

-- Ejecutar el procedimiento almacenado para transferir $200 de la cuenta A a la cuenta B
CALL transferir(1, 2, 200.00);

-- Verificar los saldos después de la transferencia
SELECT * FROM cuentas;
